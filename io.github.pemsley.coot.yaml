app-id: io.github.pemsley.coot
runtime: org.freedesktop.Platform
runtime-version: "24.08"
sdk: org.freedesktop.Sdk
command: coot
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  - --device=dri
  - --filesystem=host
  - --share=network

modules:
  - name: fftw2
    sources:
      - type: archive
        url: https://fftw.org/fftw-2.1.5.tar.gz
        sha256: f8057fae1c7df8b99116783ef3e94a6a44518d49c72e2e630c24b689c6022630
    buildsystem: autotools
    config-opts:
      - --enable-shared
      - --enable-float
      - --disable-static
    build-commands:
      - |
        if [ "$(uname -m)" = "aarch64" ]; then
          sed -i 's/-flat_namespace -undefined suppress/-undefined dynamic_lookup/g' configure
        fi
        ./configure --prefix=/app --enable-shared --enable-float --disable-static
        make
        make install

  - name: mmdb2
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/mmdb2-2.0.22.tar.gz
        sha256: a9646933ce9f34633e1ae4901f2383af0e5318d6490851328f5b6aa06195ab51
    buildsystem: autotools
    config-opts:
      - --enable-shared
      - --disable-static
    build-options:
      env:
        CXXFLAGS: "-g -O2"
    build-commands:
      - |
        ./configure --prefix=/app --enable-shared --disable-static
        make
        make install

  - name: libccp4
    sources:
      - type: archive
        url: https://github.com/cctbx/ccp4io/archive/b58c4fb68902e4e6a58f4a585d0722e542516076.tar.gz
        sha256: f1edc5a830cd4a078eae700e14b1d89612fb7a12318094363642340aafe41af6
    buildsystem: simple
    build-options:
      env:
        CPPFLAGS: "-I${FLATPAK_BUILDIR}/libccp4/lib"
        LDFLAGS: "-L${FLATPAK_DEST}/lib"
    build-commands:
      - |
        cd libccp4
        ./configure --prefix="/app" --enable-shared --disable-static --disable-fortran
        make
        make install

  - name: clipper4coot
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/clipper-2.1.20180802.tar.gz
        sha256: 7c7774f224b59458e0faa104d209da906c129523fa737e81eb3b99ec772b81e0
      - type: patch
        path: clipper-configure-2.patch
        sha256: 3cf0a68163451773e9764c11c740fcbd1a91daf9d5782d94049b90f3cd1fe5ae
    buildsystem: autotools
    config-opts:
      - --enable-mmdb
      - --enable-ccp4
      - --enable-cif
      - --enable-minimol
      - --enable-cns
      - --enable-shared
      - --disable-static
    build-options:
      cxxflags: "-g -O2 -fno-strict-aliasing -Wno-narrowing"
      env:
        LDFLAGS: "-L/app/lib"
        CPPFLAGS: "-I/app/include"
    build-commands:
      - |
        export CXXFLAGS="-g -O2 -fno-strict-aliasing -Wno-narrowing"
        export LDFLAGS="-L${FLATPAK_DEST}/usr/lib/fftw2/lib"
        export CPPFLAGS="-I${FLATPAK_DEST}/usr/include/fftw2"

        # Configure and build Clipper4coot
        ./configure --prefix=/app --enable-mmdb --enable-ccp4 --enable-cif --enable-minimol --enable-cns --enable-shared --disable-static
        make
        make install

  - name: libgd
    sources:
      - type: archive
        url: https://github.com/libgd/libgd/releases/download/gd-2.3.3/libgd-2.3.3.tar.xz
        sha256: 3fe822ece20796060af63b7c60acb151e5844204d289da0ce08f8fdf131e5a61
      - type: patch
        path: gd.h.patch
        sha256: 1015f6e125f139a1e922ac4bc2a18abbc498b0142193fa692846bf0f344a3691
    buildsystem: autotools
    config-opts:
      - --without-x
      - --without-xpm
    build-options:
      env:
        CFLAGS: "-I/app/include"
        LDFLAGS: "-L/app/lib"
    build-commands:
      - ./configure --prefix=/app --with-fontconfig=/app --with-freetype=/app --with-jpeg=/app --with-avif=/app --with-png=/app --with-tiff=/app --with-webp=/app --without-x --without-xpm
      - make
      - make install

  - name: raster3d
    sources:
      - type: archive
        url: http://www.bmsc.washington.edu/raster3d/Raster3D_3.0-7.tar.gz
        sha256: f566b499fee341db3a95229672c6afdbdb69da7faabdbe34f6e0d332d766160c
    buildsystem: simple
    build-commands:
      - |
        export CFLAGS="-I${FLATPAK_DEST}/include"
        export LDFLAGS="-L${FLATPAK_DEST}/lib"
        export PATH="${FLATPAK_DEST}/bin:$PATH"
        sed -i 's|prefix  = /usr/local|prefix  = /app|' Makefile.template
        sed -i 's|INCDIRS  =	-I/usr/include -I/usr/local/include|INCDIRS  = -I/app/include|' Makefile.template
        sed -i 's|LIBDIRS  =	-L/usr/local/lib|LIBDIRS  = -L/app/lib|' Makefile.template
        sed -i 's|mandir  = $(prefix)/man/manl|mandir  = /app/man/manl|' Makefile.template
        make linux
        make all
        make install

  - name: ssm
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/dependencies/ssm-1.4.tar.gz
        sha256: 56e7e64ed86d7d9ec59500fd34f26f881bdb9d541916d9a817c3bfb8cf0e9508
    buildsystem: autotools
    config-opts:
      - --enable-ccp4
      - --enable-shared
      - --disable-static
    build-options:
      cflags: "-fPIC"
    build-commands:
      - ./configure --prefix=/app --enable-ccp4 --enable-shared --disable-static
      - make
      - make install

  - name: boost
    sources:
      - type: archive
        url: https://github.com/boostorg/boost/releases/download/boost-1.83.0/boost-1.83.0.tar.gz
        sha256: 0c6049764e80aa32754acd7d4f179fd5551d8172a83b71532ae093e7384e98da
    buildsystem: simple
    build-commands:
      - ./bootstrap.sh --with-icu=/app --prefix=/app --libdir=/app/lib
      - ./b2 install --prefix=/app --libdir=/app/lib -d2 -j$(nproc) threading=multi link=shared,static
    config-opts:
      - --without-libraries=[python, mpi]
    build-options:
      env:
        CXXFLAGS: "-std=c++14"
    cleanup:
      - /app/share/boost

  - deps/pypi-dependencies.json

  - name: gobject-introspection
    buildsystem: meson
    config-opts:
      - -Dpython=/usr/bin/python3
    builddir: true
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gobject-introspection/1.82/gobject-introspection-1.82.0.tar.xz
        sha256: 0f5a4c1908424bf26bc41e9361168c363685080fbdb87a196c891c8401ca2f09
    post-install:
      - ln -sf /app/libexec/bin/* /app/bin/

  - name: boost-python3
    sources:
      - type: archive
        url: https://github.com/boostorg/boost/releases/download/boost-1.83.0/boost-1.83.0.tar.gz
        sha256: 0c6049764e80aa32754acd7d4f179fd5551d8172a83b71532ae093e7384e98da
    buildsystem: simple
    build-commands:
      - echo "using python" > user-config.jam
      - echo ": 3.12" >> user-config.jam
      - echo ": /usr/bin/python3" >> user-config.jam
      - echo ": /usr/include/python3.12" >> user-config.jam
      - echo ": /usr/lib" >> user-config.jam
      - echo ";" >> user-config.jam
      - ./bootstrap.sh --prefix=/app --libdir=/app/lib --with-python=python3.12 --with-python-root=/usr --with-libraries=python
      - ./b2 --build-dir=build-python3 --stagedir=stage-python3 --prefix=/app --libdir=/app/lib abi=sysv linkflags=-L/usr/lib --user-config=user-config.jam python=3.12 -d2 -j$(nproc) --layout=system threading=multi link=shared,static install
    build-options:
      env:
        CXXFLAGS: "-std=c++14"
        PYTHON: "/usr/bin/python3"
        PYTHONINCLUDE: "/usr/include/python3.12"
        PYTHONLIB: "/usr/lib"
    cleanup:
      - /app/share/boost

  - name: libdwarf
    sources:
      - type: archive
        url: https://www.prevanders.net/libdwarf-0.11.0.tar.xz
        sha256: 846071fb220ac1952f9f15ebbac6c7831ef50d0369b772c07a8a8139a42e07d2
    buildsystem: simple
    build-options:
      environment:
        PKG_CONFIG_PATH: /app/lib/pkgconfig
    build-commands:
      - if [ "${FLATPAK_BUILDER}" = "true" ]; then sh autogen.sh; fi
      - ./configure --prefix=/app --enable-shared
      - make
      - make install

  - name: gsl
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/gsl/gsl-2.8.tar.gz
        sha256: 6a99eeed15632c6354895b1dd542ed5a855c0f15d9ad1326c6fe2b2c9e423190
    buildsystem: simple
    builddir: true
    build-commands:
      - ./configure --prefix=/app
      - make
      - make install

  - name: glm
    sources:
      - type: archive
        url: https://github.com/g-truc/glm/archive/refs/tags/1.0.1.tar.gz
        sha256: 9f3174561fd26904b23f0db5e560971cbf9b3cbda0b280f04d5c379d03bf234c
    buildsystem: cmake
    build-options:
      build-tests: false
    build-commands:
      - cmake -S . -B build -DGLM_BUILD_TESTS=OFF -DBUILD_SHARED_LIBS=ON -DCMAKE_INSTALL_PREFIX=/app
      - cmake --build build
      - cmake --install build
      - |
        echo 'prefix=/app
        includedir=${prefix}/include
        libdir=${prefix}/lib

        Name: GLM
        Description: OpenGL Mathematics
        Version: 1.0.1
        Cflags: -I${includedir}' > /app/lib/pkgconfig/glm.pc

  - name: gtk4
    sources:
      - type: archive
        url: https://download.gnome.org/sources/gtk/4.16/gtk-4.16.2.tar.xz
        sha256: 34b624848e5de22a138b675ad6f39c0c7b9d67907c10e1fc7e5b03060e8d5437
    buildsystem: meson
    config-opts:
      - -Dbuild-examples=false
      - -Dbuild-tests=false
      - -Dintrospection=enabled
      - -Dman-pages=false
      - -Dmedia-gstreamer=disabled
      - -Dvulkan=disabled
    build-options:
      environment:
        DESTDIR: "/app"
        CPPFLAGS: "-DG_DISABLE_ASSERT -DG_DISABLE_CAST_CHECKS"
    build:
      commands:
        - meson setup build
        - meson compile -C build
        - meson install -C build
    post-install:
      commands:
        - glib-compile-schemas /app/share/glib-2.0/schemas
        - gtk4-update-icon-cache -f -t /app/share/icons/hicolor
        - gio-querymodules /app/lib/gtk-4.0/4.0.0/printbackends

  - name: openblas
    sources:
      - type: archive
        url: https://github.com/OpenMathLib/OpenBLAS/archive/refs/tags/v0.3.28.tar.gz
        sha256: f1003466ad074e9b0c8d421a204121100b0751c96fc6fcf3d1456bd12f8a00a1
    buildsystem: simple
    builddir: true
    build-commands:
      - export DYNAMIC_ARCH=1
      - export USE_OPENMP=1
      - export NUM_THREADS=56
      - export TARGET=$(uname -m)
      - export NO_SVE=1
      - make CC=gcc FC=gfortran libs netlib shared -j1
      - make PREFIX=/app install
      - ln -s /app/lib/libopenblas.so /app/lib/libblas.so
      - ln -s /app/lib/libopenblas.so /app/lib/liblapack.so

  - name: bdw-gc
    sources:
      - type: git
        url: https://github.com/ivmai/bdwgc
        tag: v8.2.4
    buildsystem: autotools
    config-opts:
      - --disable-debug
      - --disable-docs
      - --disable-dependency-tracking

  - name: guile
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/guile/guile-2.2.7.tar.xz
        sha256: cdf776ea5f29430b1258209630555beea6d2be5481f9da4d64986b077ff37504
    buildsystem: autotools
    config-opts:
      - --with-libltdl-prefix=/app
      - --with-libreadline-prefix=/app

  - name: g-wrap
    sources:
      - type: archive
        url: http://savannah.nongnu.org/download/g-wrap/g-wrap-1.9.15.tar.gz
        sha256: 0ff6e2700e74b457323726f7c2551a466d8ba44339705f6792d7b533145c602a
    buildsystem: autotools
    config-opts:
      - --disable-Werror

  - name: guile-cairo
    sources:
      - type: archive
        url: http://download.savannah.gnu.org/releases/guile-cairo/guile-cairo-1.10.0.tar.gz
        sha256: ae3d7e0f0a8ae93d0a15c692514eb30f2478d407052064976fc59a291cccdd5c
    buildsystem: autotools

  - name: guile-lib
    buildsystem: autotools
    sources:
      - type: archive
        url: https://download.savannah.nongnu.org/releases/guile-lib/guile-lib-0.2.7.tar.gz
        sha256: e4ef3b845f121882c7c0cf04f81a1cb8fd360c6f64b56b868de5546214f904de
    config-opts:
      - --with-guile-site=yes

  - name: guile-gnome-platform
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/guile-gnome/guile-gnome-platform/guile-gnome-platform-2.16.5.tar.gz
        sha256: 298d8c4f9b567bfe87beda18ed58d047c2e01b88c80895129de5466b921ccebe
    buildsystem: autotools
    build-options:
      - CFLAGS: "-Wall"

  - name: gemmi
    sources:
      - type: git
        url: https://github.com/project-gemmi/gemmi.git
        commit: a928991bc31983d99b3aeffc01794313b6638613
    buildsystem: cmake

  - name: Catch2
    sources:
      - type: archive
        url: https://github.com/catchorg/Catch2/archive/refs/tags/v3.7.1.tar.gz
        sha256: c991b247a1a0d7bb9c39aa35faf0fe9e19764213f28ffba3109388e62ee0269c
    buildsystem: cmake
    builddir: true
    config-opts:
      - "-DCMAKE_CXX_STANDARD=17"

  - name: eigen
    buildsystem: simple
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.3.9/eigen-3.3.9.tar.gz
        sha256: 7985975b787340124786f092b3a07d594b2e9cd53bbfe5f3d9b1daee7d55f56f
    build-commands:
      - cmake -S . -B eigen-build -Dpkg_config_libdir=/app/lib/pkgconfig -DCMAKE_INSTALL_PREFIX=/app
      - cmake --install eigen-build --prefix=/app
      - install -D cmake/FindEigen3.cmake /app/share/cmake/Modules/FindEigen3.cmake

  - name: maeparser
    buildsystem: cmake
    sources:
      - type: git
        url: https://github.com/schrodinger/maeparser
        tag: v1.3.1
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/maeparser
      - cp -r * /app/tmp/maeparser

  - name: coordgenlibs
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/schrodinger/coordgenlibs
        tag: v3.0.2
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/coordgen
      - cp -r * /app/tmp/coordgen

  - name: RingDecomposerLib
    sources:
      - type: git
        url: https://github.com/rareylab/RingDecomposerLib
        tag: v1.1.3_rdkit
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/RingDecomposerLib
      - cp -r * /app/tmp/RingDecomposerLib

  - name: pubchem-align3d
    sources:
      - type: git
        url: https://github.com/ncbi/pubchem-align3d
        commit: daefab3dd0c90ca56da9d3d5e375fe4d651e6be3
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/pubchem-align3d
      - cp -r * /app/tmp/pubchem-align3d

  - name: rapidjson
    sources:
      - type: git
        url: https://github.com/Tencent/rapidjson
        commit: 858451e5b7d1c56cf8f6d58f88cf958351837e53
    buildsystem: simple
    build-commands:
      - mkdir -p /app/tmp/rapidjson-1.1.0
      - cp -r * /app/tmp/rapidjson-1.1.0

  - name: rdkit
    sources:
      - type: archive
        url: https://github.com/rdkit/rdkit/archive/refs/tags/Release_2023_09_4.tar.gz
        sha256: abacae431bbc5882b87cc8629b7ddc02757204e854aa45b6157ec2bf45d623ef
    buildsystem: simple
    build-commands:
      - cp -r /app/tmp/RingDecomposerLib External/RingFamilies/
      - cp -r /app/tmp/pubchem-align3d External/pubchem_shape/
      - cp -r /app/tmp/maeparser External/CoordGen/
      - cp -r /app/tmp/coordgen External/CoordGen/
      - cp -r /app/tmp/rapidjson-1.1.0 External/
      - mkdir build
      - cmake -S . -B build -DCMAKE_PREFIX_PATH=/app -DCMAKE_INSTALL_PREFIX=/app -DCatch2_DIR=/app -DPYTHON_EXECUTABLE=/usr/bin/python3 -DPYTHON_INCLUDE_DIR=/usr/include/python3.12 -DRDK_BUILD_CAIRO_SUPPORT=ON -DRDK_INSTALL_INTREE=OFF -DRDK_INSTALL_COMIC_FONTS=OFF -DRDK_BUILD_MAEPARSER_SUPPORT=OFF
      - cd build && make -j5 && make install

  - name: coot
    sources:
      - type: archive
        url: https://www2.mrc-lmb.cam.ac.uk/personal/pemsley/coot/source/releases/coot-1.1.10.tar.gz
        sha256: 447caa7bdd6f87b738d20f8db15aa278476c308e22506004ed145e04f85e0413
      - type: file
        path: io.github.pemsley.coot.metainfo.xml
      - type: file
        path: io.github.pemsley.coot.desktop
    buildsystem: autotools
    config-opts:
      - --with-fftw-prefix=/app
      - --with-boost=/app
      - --with-boost-libdir=/app/lib
      - --with-rdkit-prefix=/app
      - --with-enhanced-ligand-tools
      - --with-guile
      - PYTHON=python3
      - SHELL=/bin/bash
    build-options:
      append-path:
        - /app/lib
        - /app/bin
      environment:
        CXXFLAGS: "-g -O -fPIC"
        CPPFLAGS: "-D_USE_BOOST=1"
        LDFLAGS: "-L/app/lib -L/app/lib64 -L/usr/lib -lpython3.12"
        LD_LIBRARY_PATH: "/app/lib64:/app/lib:/usr/lib"
    post-install:
      - install -Dm644 pixmaps/icons/hicolor_apps_scalable_coot.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg
      - install -Dm644 ${FLATPAK_ID}.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
    cleanup:
      - /usr/lib/python*/site-packages/__pycache__
      - /lib/pkgconfig
      - /share/aclocal
      - /share/doc
      - /share/info
      - /share/man
      - /app/share/man
      - /app/share/doc
      - /app/lib/*.a
      - /app/lib/*.la
      - /app/tmp
